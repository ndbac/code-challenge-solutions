flowchart TD
    %% User and Client Layer
    User[ðŸ‘¤ User] --> Action[ðŸŽ® Performs Game Action]
    Action --> WebApp[ðŸŒ Web Application]
    
    %% Action Token Generation
    WebApp --> ActionSystem[âš¡ Action Generation System]
    ActionSystem --> TokenGen{ðŸŽ« Generate Action Token}
    TokenGen --> |Signed Token| WebApp
    
    %% API Request Flow
    WebApp --> |POST /api/v1/scores/update| LoadBalancer[âš–ï¸ Load Balancer]
    LoadBalancer --> APIGateway[ðŸšª API Gateway]
    
    %% Authentication Flow
    APIGateway --> AuthCheck{ðŸ” JWT Valid?}
    AuthCheck --> |No| AuthError[âŒ 401 Unauthorized]
    AuthCheck --> |Yes| RateLimit{ðŸš¦ Rate Limit Check}
    
    %% Rate Limiting
    RateLimit --> |Exceeded| RateLimitError[âŒ 429 Too Many Requests]
    RateLimit --> |OK| TokenValidation{ðŸŽ« Action Token Valid?}
    
    %% Token Validation
    TokenValidation --> |Invalid| TokenError[âŒ Invalid Token]
    TokenValidation --> |Valid| ScoreService[ðŸ“Š Score Management Service]
    
    %% Score Processing
    ScoreService --> DBTransaction{ðŸ—„ï¸ Begin Transaction}
    DBTransaction --> UpdateScore[ðŸ“ˆ Update User Score]
    UpdateScore --> LogAction[ðŸ“ Log Score Update]
    LogAction --> MarkTokenUsed[âœ… Mark Token as Used]
    MarkTokenUsed --> CommitTx{ðŸ’¾ Commit Transaction}
    
    %% Transaction Results
    CommitTx --> |Success| CacheUpdate[âš¡ Update Cache]
    CommitTx --> |Failure| Rollback[ðŸ”„ Rollback & Error]
    
    %% Cache and Real-time Updates
    CacheUpdate --> InvalidateCache[ðŸ—‘ï¸ Invalidate Leaderboard Cache]
    InvalidateCache --> GetNewLeaderboard[ðŸ† Get Updated Top 10]
    GetNewLeaderboard --> WSBroadcast[ðŸ”Œ WebSocket Broadcast]
    
    %% WebSocket Flow
    WSBroadcast --> ConnectedClients{ðŸ‘¥ Connected Clients}
    ConnectedClients --> |Update UI| WebApp
    ConnectedClients --> |Update UI| OtherClients[ðŸ‘¥ Other Connected Users]
    
    %% Response Flow
    CacheUpdate --> SuccessResponse[âœ… Success Response]
    SuccessResponse --> WebApp
    WebApp --> |Display Update| User
    
    %% Leaderboard Query Flow
    User --> |View Leaderboard| LeaderboardRequest[ðŸ“Š GET /api/v1/scoreboard/top10]
    LeaderboardRequest --> LoadBalancer
    LoadBalancer --> LeaderboardAPI[ðŸ† Leaderboard API]
    LeaderboardAPI --> CacheCheck{âš¡ Check Redis Cache}
    CacheCheck --> |Hit| ReturnCached[ðŸ“‹ Return Cached Data]
    CacheCheck --> |Miss| QueryDB[ðŸ—„ï¸ Query Database]
    QueryDB --> UpdateCache2[âš¡ Update Cache]
    UpdateCache2 --> ReturnData[ðŸ“‹ Return Leaderboard]
    ReturnCached --> WebApp
    ReturnData --> WebApp
    
    %% WebSocket Connection Flow
    WebApp --> |Connect WebSocket| WSServer[ðŸ”Œ WebSocket Server]
    WSServer --> WSAuth{ðŸ” Authenticate WS Connection}
    WSAuth --> |Valid| WSSubscribe[ðŸ“¡ Subscribe to Updates]
    WSAuth --> |Invalid| WSReject[âŒ Reject Connection]
    WSSubscribe --> SendInitialData[ðŸ“Š Send Initial Leaderboard]
    
    %% Error Handling
    AuthError --> ErrorResponse[ðŸ“¤ Error Response]
    RateLimitError --> ErrorResponse
    TokenError --> ErrorResponse
    Rollback --> ErrorResponse
    WSReject --> CloseConnection[ðŸ”Œ Close WebSocket]
    ErrorResponse --> WebApp
    
    %% Monitoring and Logging
    ScoreService --> AuditLog[(ðŸ“ Audit Database)]
    ScoreService --> Monitoring[ðŸ“ˆ Monitoring System]
    AuthCheck --> Monitoring
    RateLimit --> Monitoring
    WSServer --> Monitoring
    
    %% Data Storage
    UpdateScore --> PostgreSQL[(ðŸ—„ï¸ PostgreSQL Database)]
    LogAction --> PostgreSQL
    CacheUpdate --> Redis[(âš¡ Redis Cache)]
    MarkTokenUsed --> Redis
    
    %% Styling
    classDef userClass fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef serviceClass fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef dataClass fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef errorClass fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef successClass fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef decisionClass fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    
    class User,WebApp,OtherClients userClass
    class ActionSystem,ScoreService,LeaderboardAPI,WSServer,LoadBalancer,APIGateway serviceClass
    class PostgreSQL,Redis,AuditLog dataClass
    class AuthError,RateLimitError,TokenError,Rollback,WSReject,ErrorResponse errorClass
    class SuccessResponse,SendInitialData,ReturnCached,ReturnData successClass
    class AuthCheck,RateLimit,TokenValidation,DBTransaction,CommitTx,CacheCheck,WSAuth,ConnectedClients decisionClass